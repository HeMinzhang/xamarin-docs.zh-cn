---
title: 创建 Android 服务
description: 本指南介绍 Xamarin.Android 服务，是 Android 组件，允许以不包含活动的用户界面完成的工作。 服务非常通常用于在较长时间计算，下载文件、 播放音乐，如在后台中执行任务等。 它介绍了服务适合于不同方案，并演示如何实现它们用于执行长时间运行后台任务以及提供接口的远程过程调用。
ms.prod: xamarin
ms.assetid: BA371A59-6F7A-F62A-02FC-28253504ACC9
ms.technology: xamarin-android
author: conceptdev
ms.author: crdun
ms.date: 03/19/2018
ms.openlocfilehash: 4ae86ca5fa47169bb5d78eb9d1116e419c23ed6d
ms.sourcegitcommit: 4b402d1c508fa84e4fc3171a6e43b811323948fc
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/23/2019
ms.locfileid: "61012470"
---
# <a name="creating-android-services"></a>创建 Android 服务

_本指南介绍 Xamarin.Android 服务，是 Android 组件，允许以不包含活动的用户界面完成的工作。服务非常通常用于在较长时间计算，下载文件、 播放音乐，如在后台中执行任务等。它介绍了服务适合于不同方案，并演示如何实现它们用于执行长时间运行后台任务以及提供接口的远程过程调用。_

## <a name="android-services-overview"></a>Android 服务概述

移动应用不像桌面应用程序。 桌面有喝许多屏幕空间、 内存、 存储空间和已连接的电源等资源，移动设备不这样做。 这些约束强制执行移动应用不同的行为。 例如，在小屏幕上移动设备通常意味着一次只有一个应用 （即活动） 可见。 其他活动都移到后台，推送到挂起状态，它们不能执行任何工作。 但是，只是因为 Android 应用程序在后台并不意味着就无法应用以继续工作。 

Android 应用程序由至少一个以下四个主要组件组成：_活动_，_广播接收器_，_内容提供商_，并且_服务_。 活动是许多出色的 Android 应用程序的基础，因为它们提供 UI，它允许用户与应用程序进行交互。 但是，当涉及到执行并发或后台工作时，活动并不总是最佳选择。
 
在 Android 中的后台工作的主要机制是_服务_。 Android 服务是用于执行某项操作而无需用户界面的组件。 服务可能会下载文件、 播放音乐，或将筛选器应用于映像。 服务还可用于进程间通信 (_IPC_) 之间的 Android 应用程序。 例如，一个 Android 应用程序可能会使用从另一个应用的音乐播放器服务或应用程序可能会公开到通过服务的其他应用数据 （例如个人的联系信息）。 

服务和其执行后台工作的能力至关重要提供平滑流畅的用户界面。 所有 Android 应用程序具有_主线程_(也称为_UI 线程_) 上的活动的运行。 若要使设备保持响应状态，Android 必须能够更新用户界面的每秒 60 帧速率。 如果 Android 应用程序主线程上执行过多的工作，则 Android 将丢弃帧，这又会导致出现显得很不稳定的 UI (有时也称为_janky_)。 这意味着在 UI 线程上执行任何操作应完成在两个帧，大约 16 毫秒 （1，第二，个每隔 60 帧） 之间的时间范围。 

为了解决此问题，开发人员可能会使用线程在活动中来执行某些工作会阻止 UI。 但是，这可能导致问题。 它是很有可能，Android 将销毁并重新创建活动的多个实例。 但是，Android 将自动销毁线程，这可能导致内存泄漏。 最好的例子是何时[设备旋转](~/android/app-fundamentals/handling-rotation.md) &ndash; Android 会尝试销毁该活动的实例，然后重新创建一个新：

![当设备旋转时，销毁实例 1 并创建实例 2](images/image-01.png)

这是可能的内存泄漏&ndash;仍在运行该活动的第一个实例所创建的线程。 如果线程可以对活动的第一个实例的引用，这将防止垃圾收集该对象从 Android。 但是，该活动的第二个实例仍将创建 （这又可能会创建一个新线程）。 旋转几个场合中快速而连续的设备可能会耗尽所有 RAM 和强制 Android 终止整个应用程序以回收内存。

根据经验，如果要执行的工作应生存期长于活动，则服务应创建用于完成该工作。 但是，如果工作只是适用于活动的上下文，然后创建线程来执行的工作可能是更合适。 例如，创建缩略图照片刚才添加到照片库应用程序应可能会出现在服务中。 但是，一个线程可能更适合播放活动位于前台时，应仅可以听到一些音乐。

后台工作可以分为两个宽泛的分类：

1. **长时间运行任务** &ndash; ，这是正在进行，直到显式停止工作。 举例_长时间运行的任务_是流式传输音乐一款应用或，必须监视从传感器收集的数据。 即使应用程序没有可视用户界面，必须运行这些任务。
2. **定期任务** &ndash; (有时称为_作业_) 定期任务是指属于相对较短的持续时间 （几秒钟之内），按计划运行 (即一天一次一周或可能的只是一次在下一步是 60 秒）。 出现这种不可从 internet 下载文件，或生成图像的缩略图。

有四种不同类型的 Android 服务：

* **绑定服务** &ndash; A_绑定服务_是具有某些其他组件 （通常活动） 绑定到它的服务。 绑定的服务提供可绑定的组件和服务彼此交互的接口。 一旦绑定到的服务没有更多客户端，Android 将关闭该服务。 

* **`IntentService`** &ndash; _`IntentService`_ 是一个专门的子类`Service`类，用于简化服务创建和使用情况。 `IntentService`旨在处理各个自治的调用。 与一个服务，它可以同时处理多个调用，不同`IntentService`更像是_工作队列处理器_&ndash;工作排队等候和`IntentService`在单个工作线程上一次处理一个每个作业。 通常情况下，`IntentService`未绑定到的活动或片段。 

* **已启动服务** &ndash; A_已启动服务_是已启动一些其他 Android 组件 （如活动），直到内容显式告知在后台持续运行的服务若要停止的服务。 不同于绑定的服务，已启动的服务不具有直接绑定到它的任何客户端。 出于此原因，务必设计，以便它们可以正常重新启动在必要时启动的服务。

* **混合服务** &ndash; A_混合服务_是一项服务具有的特征_已启动服务_和一个_绑定服务_。 组件绑定到它或它可能由某些事件启动时，可以通过启动一种混合服务。 客户端组件可能会或可能未绑定到混合服务。 一种混合服务将继续运行，直到明确指示若要停止，或者没有任何绑定到它的多个客户端。

要使用的类型是服务的非常依赖于应用程序的要求。 根据经验，`IntentService`或绑定的服务是足以满足大多数任务都必须执行的 Android 应用程序，因此首选项应授予给服务这两种类型之一。 `IntentService`是"单稳"任务，例如下载文件，而需要与活动/片段的频繁交互时，绑定的服务也可能适用的一个不错选择。 

尽管大多数服务在后台运行，还有一个特殊的子类别，称为_前景服务_。 这是一种服务，提供更高的优先级 （与普通服务相比） 来为用户 （如播放音乐） 执行某些任务。 

也可以在同一设备上其自己的进程中运行服务，这有时称为_远程服务_或是_进程外服务_。 这需要更多工作来创建，但也可用于应用程序需要共享功能与其他应用程序，并可以在某些情况下，提高应用程序的用户体验。 

### <a name="background-execution-limits-in-android-80"></a>Android 8.0 中的后台执行限制

启动 Android 8.0 （API 级别为 26） 在 Android 应用程序不再能够自由地在后台运行。 当在前台，应用可以启动和运行不受限制的服务。 当应用程序移动到后台时，Android 将授予该应用程序一定的时间启动和使用服务。 后经过指定的时间，则应用无法再启动任何服务和启动的任何服务将被终止。 此时不能执行任何工作的应用。 Android 要考虑的应用程序位于前台，如果满足以下条件之一：

* 没有可见的活动 （启动或暂停）。
* 应用程序已开始的前景色服务。
* 另一个应用程序位于前台，并使用从应用程序都将成为在后台的组件。 此示例是如果应用程序 A，位于前台，绑定到所提供的服务应用程序 b。 应用程序 B 然后也将是被视为在前台，但在后台正在终止 android。

有某些情况下，其中，即使应用是在后台，Android 将唤醒应用和放宽这些限制等几分钟，可通过应用程序来执行某些工作：
* 高优先级应用接收 Firebase 云消息。
* 应用程序将收到一个广播。 
* 应用程序接收并执行`PendingIntent`以响应一条通知。

现有 Xamarin.Android 应用程序可能需要更改其执行后台工作以避免可能出现在 Android 8.0 上的任何问题的方式。 下面是一些实用的替代方案到 Android 服务：

* **计划在使用 Android 作业计划程序在后台中运行的工作或[Firebase 作业调度程序](~/android/platform/firebase-job-dispatcher.md)** &ndash;这两个库提供一个框架，用于应用程序分离到中的后台工作_作业_，离散的工作单位。 可以在运行作业时，应用程序然后可以有关计划操作系统以及某些条件的作业。
* **启动该服务在前台**&ndash;前景服务可用于应用程序时必须执行某些任务在后台，用户可能需要定期与该任务进行交互。 前景服务将显示持久通知，以便用户可以知道应用正在运行的后台任务，且还提供了一种方法来监视或与任务交互。 此示例将向用户播放播客或可能下载播客一集中，以便可以更高版本感到满意的主发挥播客应用。 
* **使用高优先级 Firebase 云消息 (FCM)** &ndash;时 Android 接收应用程序的高优先级 FCM，它将允许该应用将在后台服务运行的时间短时间。 这将是具有后台服务，可以轮询在后台中的应用的良好替代方法。 
* **推迟工作的应用程序时进入前台**&ndash;如果先前的解决方案不可行的则应用必须开发其自己的方法来暂停和继续工作时应用程序转入前台。

## <a name="related-links"></a>相关链接

* [Android Oreo 后台执行限制](https://www.youtube.com/watch?v=Pumf_4yjTMc)
