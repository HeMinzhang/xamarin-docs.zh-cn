---
title: 容器化微服务
description: 本章介绍如何使用微服务和容器生成敏捷、 可缩放和可靠的现代云应用程序。
ms.prod: xamarin
ms.assetid: 5872ad92-04e0-4f1a-9691-79d5602f5683
ms.technology: xamarin-forms
author: davidbritch
ms.author: dabritch
ms.date: 08/07/2017
ms.openlocfilehash: 33be84bc17f72c8b70d117a0742b001f1f763d3d
ms.sourcegitcommit: 66682dd8e93c0e4f5dee69f32b5fc5a96443e307
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/08/2018
ms.locfileid: "35242256"
---
# <a name="containerized-microservices"></a>容器化微服务

开发客户端-服务器应用程序导致了的重点在于生成的每个层中使用的特定技术分层应用程序。 此类应用程序通常称为*整体*应用程序，并打包到预缩放的峰值负载的硬件上。 采用此开发方法的主要缺点是，不能轻松缩放各个组件，每个层中的组件和测试的成本之间的紧密耦合。 简单的更新可以具有剩余的层上, 出现未预见的影响，因此对应用程序组件的更改需要重新测试并重新部署其整个层。

特别是与在云中的时代，各个组件不能轻松缩放。 整体应用程序包含特定于域的功能，并通常除以前端、 业务逻辑和数据存储之类的功能层。 图 8-1 中所示，通过克隆到多个计算机，则整个应用程序进行缩放的整体应用程序。

![](containerized-microservices-images/monolithicapp.png "整体应用程序缩放方法")

**图 8-1**： 缩放方法的整体应用程序

## <a name="microservices"></a>微服务

微服务提供了应用程序开发和部署到不同的方法、 一种方法适合灵活性、 缩放和现代云应用程序的可靠性要求。 微服务应用程序分解为协同工作以提供应用程序的总体功能的独立组件。 术语 microservice 强调，应用程序应组成服务足够小，以反映独立问题，以便每个微服务实现单个函数。 此外，每个微服务具有定义完善的协定，以便其他微服务可以进行通信并与之共享数据。 微服务的典型示例包括购物车，库存处理、 购买子系统和付款处理。

微服务可以向外扩展独立，相比特大进行整体缩放的单一应用程序。 这意味着，某个特定的功能区域，需要更多的处理能力或网络带宽，来支持需求，可以进行扩展而不是不必要地向外缩放应用程序的其他区域。 图 8-2 演示了此方法，其中微服务是单独部署和缩放，多台计算机之间创建的服务实例。

![](containerized-microservices-images/microservicesapp.png "微服务应用程序缩放方法")

**图 8-2**： 微服务应用程序缩放方法

Microservice 横向扩展可以是几乎瞬间完成，以便应用程序以适应不断变化的负荷。 例如，在应用程序的面向 web 的功能单个 microservice 可能是唯一的微服务构成的应用程序需要向外扩展以处理其他传入的流量中。

应用程序可伸缩性的经典模型是使用共享的外部数据存储来存储持久性数据的负载平衡，则无状态的层。 有状态微服务管理其自己的持久性数据，通常在放置它们的服务器上本地存储它，以避免网络开销访问和复杂性的跨服务操作。 这使可能处理速度最快的数据，可以消除对缓存系统的需要。 此外，可缩放的有状态微服务通常分区在其实例，可以管理一台服务器可以支持超过该值的数据大小和传输吞吐量之间的数据。

微服务还支持独立的更新。 这种松耦合微服务之间提供了快速和可靠的应用程序的发展。 独立的分布式性质支持滚动更新，其中的单个微服务实例的一个子集将更新在任何给定时间。 因此，如果检测到问题时，错误更新可以将其回滚之前使用的故障代码或配置更新所有实例。 同样，微服务通常使用架构版本管理，以便在应用更新，而不考虑哪些微服务实例正在与进行通信时，客户端看到一致的版本。

因此，微服务应用程序对整体的应用程序拥有许多好处：

-   每个微服务是相对较小的、 易于管理和改进。
-   每个微服务可以开发和部署独立于其他服务。
-   每个微服务可以独立地向外扩展。 例如，目录服务或购物篮服务可能需要向外扩展的多个排序的服务。 因此，生成基础结构将更有效地使用资源，如果向外扩展。
-   每个微服务隔离了任何问题。 例如，如果在服务中没有问题它只会影响该服务。 其他服务可以继续处理请求。
-   每个微服务可以使用最新的技术。 由于微服务是自治和运行的并行，最新技术和框架可用，而不强制使用单一应用程序可能使用较旧框架。

但是，基于 microservice 解决方案还具有潜在缺点：

-   选择分区到微服务应用程序的方式可以很困难，因为每个微服务必须是完全自治、 端到端，包括负责其数据源。
-   开发人员必须实现服务间通信，向应用程序的复杂性和延迟。
-   通常多个微服务之间的原子事务不可能实现。 因此，业务要求必须采用微服务之间的最终一致性。
-   在生产中，是在部署和管理系统泄露的许多独立的服务操作的复杂性。
-   直接微服务构成客户端通信会使困难重构微服务的协定。 例如，随着时间的推移如何系统分区到服务可能需要更改。 单个服务可能将拆分为两个或多个服务，并可能会将合并两个服务。 当客户端直接与微服务通信时，此重构工作可以中断与客户端应用程序兼容性。

## <a name="containerization"></a>容器化

容器化是一种方法，在其中应用程序和其已进行版本管理的一套依赖关系，以及抽象化为部署清单文件，其环境配置它们打包在一起作为容器映像，作为一个单元测试的软件开发和部署到主机的操作系统。

容器是隔离、 资源控制且可移植运行环境，可在其中应用程序运行而无需触摸的其他容器或主机的资源。 因此，容器看起来像新安装的物理计算机或虚拟机。

图 8-3 中所示，有许多容器和虚拟机之间的相似之处。

![](containerized-microservices-images/containersvsvirtualmachines.png "微服务应用程序缩放方法")

**图 8-3**： 虚拟机和容器的比较

容器在操作系统上运行、 具有文件系统，并就像它是物理或虚拟机可以通过网络访问。 但是的技术和概念容器使用的是虚拟机的不同。 虚拟机包括应用程序、 必需的依赖项和完整的来宾操作系统。 容器包括应用程序以及其依赖关系，但与作为独立进程运行在主机操作系统 （除了在特殊的虚拟机，每个容器的内部运行 HYPER-V 容器） 上的其他容器共享操作系统。 因此，容器共享资源，但通常需要较少的资源比虚拟机。

容器面向的开发和部署方法的优点是它消除了大部分导致不一致的环境的设置和附带这些问题的问题。 此外，容器通过实例化新的容器，根据需要允许快速应用程序不断增长的功能。

创建和使用容器时，关键的概念是：

-   容器主机： 物理计算机或虚拟机以托管容器配置。 容器主机将运行一个或多个容器。
-   容器映像： 图像包含的堆叠的分层文件系统的联合，并且是容器的基础。 映像不包含状态，并且永远不会更改为部署到不同的环境。
-   容器： 容器是映像的运行时实例。
-   容器操作系统映像： 从映像部署容器。 容器操作系统映像是可能的许多映像层组成容器的第一层。 容器操作系统是不可变，并且不能修改。
-   容器存储库： 每次创建容器映像时的映像，以及其依赖项存储在本地存储库。 这些映像可以在容器主机上重复使用多次。 容器映像也存储在公共或私有注册表，如[Docker Hub](https://hub.docker.com/)，以便可以在不同的容器主机上使用它们。

企业日益正在采用容器实现 microservice 基于应用程序，并且 Docker 已变为已由大多数软件平台和云供应商采用的标准容器实现。

EShopOnContainers 引用应用程序使用 Docker 来托管四个容器化的后端微服务，如图 8-4 中所示。

![](containerized-microservices-images/microservicesarchitecture.png "eShopOnContainers 引用应用程序后端微服务")

**图 8-4**: eShopOnContainers 引用应用程序后端微服务

引用应用程序中的后端服务的体系结构将分解协作微服务和容器的窗体中的多个自治子系统。 每个微服务提供的功能的单一区域： 标识服务、 目录服务、 排序服务和购物篮服务。

每个微服务都有自己的数据库，使其能够从其他微服务完全分离。 在必要时，从不同的微服务的数据库之间的一致性是使用应用程序级事件实现的。 有关详细信息，请参阅[之间微服务通信](#communication_between_microservices)。

有关引用应用程序的详细信息，请参阅[.NET 微服务： 为容器化.NET 应用程序的体系结构](https://aka.ms/microservicesebook)。

<a name="communication_between_client_and_microservices" />

## <a name="communication-between-client-and-microservices"></a>客户端和微服务之间的通信

EShopOnContainers 移动应用进行通信的容器化的后端微服务使用*直接微服务构成客户端*通信，在图 8-5 中所示。

![](containerized-microservices-images/directclienttomicroservicecommunication.png "微服务应用程序缩放方法")

**图 8-5**： 直接微服务构成客户端通信

与直接微服务构成客户端通信，移动应用程序直接通过其公共终结点，每个微服务是其他 TCP 端口与每个微服务向发出请求。 在生产中，系统将通常将终结点映射到负载平衡器的微服务构成的集，其中将请求分布到可用的实例。

> [!TIP]
> 请考虑使用 API 网关通信。 当构建大型和复杂 microservice 基于应用程序，但它是多个适合一个小应用程序时，直接微服务构成客户端通信可以有缺点。 当设计大型 microservice 基于具有数十个微服务应用程序，请考虑使用 API 网关通信。 有关详细信息，请参阅[.NET 微服务： 为容器化.NET 应用程序的体系结构](https://aka.ms/microservicesebook)。

<a name="communication_between_microservices" />

## <a name="communication-between-microservices"></a>微服务之间的通信

基于的微服务应用程序是一个分布式的系统，可能在多台计算机上运行。 每个服务实例通常是一个进程。 因此，服务必须交互使用进程间通信协议，如 HTTP、 TCP、 高级消息队列协议 (AMQP) 或二进制协议，具体取决于每个服务的性质。

微服务构成微服务通信的两种常见方法是基于 HTTP 的 REST 通信时查询数据和轻型异步消息传送跨多个微服务通信更新时。

异步消息传送基于的事件驱动的通信至关重要时将更改传播跨多个微服务。 使用此方法，microservice 发布事件时值得一提时发生的情况，例如，它会更新业务实体的内容。 其他微服务订阅这些事件。 然后，当 microservice 收到事件时，它会更新其自己的业务实体，这反过来可能会导致正在发布的详细事件。 此发布-订阅功能通常使用的事件总线实现。

事件总线允许发布-订阅微服务，而无需为显式知道对方，图 8-6 中所示的组件之间的通信。

![](containerized-microservices-images/eventbus.png "使用事件总线发布-订阅")

**图 8-6:** 发布-订阅使用事件总线

从应用程序的角度看，事件总线是只需发布-订阅通过接口公开的通道。 但是，实现事件总线的方式而异。 例如，事件总线实现可以使用 RabbitMQ、 Azure Service Bus 或 MassTransit NServiceBus 等其他服务总线。 图 8-7 显示事件总线 eShopOnContainers 引用应用程序中的使用方式。

![](containerized-microservices-images/microservicesarchitecturewitheventbus.png "引用应用程序中的异步事件驱动通信")

**图 8-7:** 引用应用程序中的异步事件驱动通信

EShopOnContainers 事件总线，使用 RabbitMQ，实现提供了一到多异步发布-订阅功能。 这意味着，在发布后事件，可以有多个订阅服务器侦听同一事件。 图 8-9 阐释了此关系。

![](containerized-microservices-images/eventdrivencommunication.png "一对多通信")

**图 8-9**： 一对多的通信

此一对多的通信方法使用事件来实现业务事务跨越多个服务，确保在服务之间的最终一致性。 最终一致事务由一系列分布式步骤组成。 因此，当用户配置文件 microservice 收到 UpdateUser 命令时，它将更新其数据库中的用户的详细信息，并将 UserUpdated 事件发布到事件总线。 购物篮微服务和排序 microservice 已订阅接收此事件，并在响应中更新中其各自数据库其购买者信息。

> [!NOTE]
> 使用 RabbitMQ，实现的 eShopOnContainers 事件总线旨在仅用作概念证明。 对于生产系统，应考虑备用事件总线实现。

有关事件总线实现的信息，请参阅[.NET 微服务： 为容器化.NET 应用程序的体系结构](https://aka.ms/microservicesebook)。

## <a name="summary"></a>总结

微服务提供一种方法应用程序开发和部署适用于现代云应用程序的灵活性、 缩放和可靠性要求。 微服务的主要优势之一是，它们可以是向外扩展的独立，这意味着需要更多的处理断电或网络带宽，以支持需，不进行不必要地缩放的区域，可以扩展的特定功能区域没有遇到提高的需求，应用程序。

容器是隔离、 资源控制且可移植运行环境，可在其中应用程序运行而无需触摸的其他容器或主机的资源。 企业日益正在采用容器实现 microservice 基于应用程序，并且 Docker 已变为已由大多数软件平台和云供应商采用的标准容器实现。


## <a name="related-links"></a>相关链接

- [下载电子书 (2 Mb PDF)](https://aka.ms/xamarinpatternsebook)
- [eShopOnContainers (GitHub) （示例）](https://github.com/dotnet-architecture/eShopOnContainers)
